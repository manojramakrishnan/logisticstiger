<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{commons/layout}">
	
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Login</title>
<link rel="stylesheet" type="text/css"
	href="css/bootstrap.min.css">
<link rel="stylesheet" type="text/css"
	href="css/model/login/login.css">
</head>
<body>
	<div class="container">
	<div class="row">
	<div class="col-md-4 col-sm-3"></div>

	<div class="col-md-4 col-sm-6">
	<div class="panel panel-default">

	<div class="panel-title" style="text-align: center">
	<h2>Log in</h2>
	</div>

	<div class="panel-body">

	<form id="login_form" class="form-horizontal" style="">

	<div class="form-group">
	<label class="control-label col-md-4 col-sm-4">user ID：</label>
	<div class="col-md-7 col-sm-7">
	<input type="text" id="userID" class="form-control"
	placeholder="user Id" name="userID" />
	</div>
	</div>

	<div class="form-group">
	<label class="control-label col-md-4 col-sm-4"> <!-- <span class="glyphicon glyphicon-lock"></span> -->
	password：
	</label>
	<div class="col-md-7 col-sm-7">
	<input type="password" id="password" class="form-control"
	placeholder="password" name="password">
	</div>
	</div>

	<div class="form-group">
	<label class="control-label col-md-4 col-sm-4"> <!-- <span class="glyphicon glyphicon-lock"></span> -->
	verification code：
	</label>
	<div class="col-md-5 col-sm-4">
	<input type="text" id="checkCode" class="form-control"
	placeholder="verification code" name="checkCode">
	</div>
	<div>
	<img id="checkCodeImg" alt="checkCodeImg"
	src="account/checkCode/1">
	</div>
	</div>

	<div>
	<div class="col-md-4 col-sm-4"></div>
	<div class="col-md-4 col-sm-4">
	<button id="submit" type="submit" class="btn btn-primary">
	&nbsp;&nbsp;&nbsp;&nbsp;login&nbsp;&nbsp;&nbsp;&nbsp;</button>
	</div>
	<div class="col-md-4 col-sm-4"></div>
	</div>
	</form>
	</div>
	</div>
	</div>

	<div class="col-md-4 col-sm-3"></div>
	</div>
	</div>

	<script type="text/javascript"
	src="${pageContext.request.contextPath}/js/jquery-2.2.3.min.js"></script>
	<script type="text/javascript"
	src="${pageContext.request.contextPath}/js/bootstrap.min.js"></script>
	<script type="text/javascript"
	src="${pageContext.request.contextPath}/js/bootstrapValidator.min.js"></script>
	<script type="text/javascript"
	src="${pageContext.request.contextPath}/js/jquery.md5.js"></script>

	<script>
	$(function() {
	validatorInit();
	refreshCheckCode();
	});
	function refreshCheckCode() {
	$('#checkCodeImg').click(function() {
	var timestamp = new Date().getTime();
	$(this).attr("src", "account/checkCode/" + timestamp)
	})
	}
	function infoEncrypt(userID, password, checkCode) {
	var str1 = $.md5(password);
	//var str2 = $.md5(str1 + userID);
	var str3 = $.md5(str1 + checkCode.toUpperCase());
	console.log("password:"+str3);
	return str3;
	}
	function validatorInit() {
	$('#login_form').bootstrapValidator({
	message : 'This value is not valid',
	feedbackIcons : {
	valid : 'glyphicon glyphicon-ok',
	invalid : 'glyphicon glyphicon-remove',
	validating : 'glyphicon glyphicon-refresh'
	},
	fields : {
	userID : {
	validators : {
	notEmpty : {
	message : 'Username can not be empty'
	},regexp: {
	regexp: '[0-9]+',
	message: 'Only numbers are allowed'
	},
	callback : {}
	}
	},
	password : {
	validators : {
	notEmpty : {
	message : 'password can not be blank'
	},
	callback : {}
	}
	},
	checkCode : {
	validators : {
	notEmpty : {
	message : 'verification code must be filled'
	}
	}
	}
	}
	})
	.on('success.form.bv', function(e) {
	e.preventDefault();
	var $form = $(e.target);
	var bv = $form.data('bootstrapValidator');
	var userID = $('#userID').val();
	var password = $('#password').val();
	var checkCode = $('#checkCode').val();
	password = infoEncrypt(userID, password, checkCode)
	var data = {
	"id" : userID,
	"password" : password,
	}
	$.ajax({
	type:"POST",
	url:"account/login",
	dataType:"json",
	contentType:"application/json",
	data:JSON.stringify(data),
	success:function(response){
	
	if(response.result == 'error'){
	var errorMessage;
	var field;
	if(response.msg == "unknownAccount"){
	errorMessage = "username error";
	field = "userID";
	}
	else if(response.msg == "incorrectCredentials"){
	errorMessage = "Incorrect password or verification code";
	field = "password";
	$('#password').val("");
	}else{
	errorMessage = "Server Error";
 field = "password";
 $('#password').val("");
	}
	
	bv.updateMessage(field,'callback',errorMessage);
	bv.updateStatus(field,'INVALID','callback');
	bv.updateStatus("checkCode",'INVALID','callback');
	
	$('#checkCodeImg').attr("src","account/checkCode/" + new Date().getTime());
	$('#checkCode').val("");
	}else{
	window.location.href = "/WMS";
	}
	},
	error:function(data){
	}
	});
	});
	}
	</script>
</body>
</html>